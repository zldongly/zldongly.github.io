# 第九章

```
redisServer struct {
    int dbnum
    redisDb *db
    ...
}
```
> dbnum 是数据库数量，redis默认有16个数据库，通过`SELECT`命令来切换0~15  
db 是一个数据库对象的数组，数组长度等于dbnum。选中一个数据库就是redisClient.db指向这个redisServer.db的某个元素。



```
redisDb struct {
    dict *dict
    dict *expires
    ...
}
```
> dict 是一个字典结构存放数据库的键值对数据  
expires 也是一个字典结构但存放的是键的过期时间，
expires的键指向dict的键，也就是expires和dict的键是同一个（共同的空间），
expires的值则是截止时间的ms时间戳，超过这个时间则这个对应的键空间过期失效。
如果键空间没有设置有效时间则不会存在于expires中。

## 过期策略
常见的过期删除策略有：
* 定时删除  
定时就是一到过期时间就删除，通过定时器实现。但对于每个键设一个定时器不现实。这种方法对CPU要求高
* 惰性删除  
惰性删除是不主动删除，只有在需要使用这个键时才会去检查是否过期。这种方法对于CPU友好，但废内存，如果一个键在过期后没有被调用，这个键空间就会一直占有内存不被回收。
* 定期删除  
定期删除就是定期(每隔一段时间)检查键是否过期。这种方法对CPU要求没这么高，友不太浪费内存，但要根据实际情况设置好定期的时长才行。

以上说的三种方法是常见的删除策略，并不是redis才用了这三种策略。
redis实际上采用的是定期删除和惰性删除两种策略的结合。  
在读取键空间是redis首先会检查这个键是否过期也就是惰性删除，没有过期才会继续执行接下来的操作，如果过期了就会删除这个键。  
redis的定期删除并不是检测所有键而是随机取一定数量的键检测是否过期。

不同情况下的删除情况  
* RDB  
生成RDB文件时会忽略过期键  
载入RDB时，如果是主服务器会检测是否过期，从服务器不检测是否过期
* AOF  
AOF不判断键是否过期，但在redis通过惰性或定期删除是AOF会记录`DEL`命令  
* 主从复制  
主服务器会检测键是否过期，发现过期后会通知从服务器。从服务器不会主动检测键是否过期也不会主动删除键，从服务器会正常返回给client已过期的键

[目录](./0.md)
