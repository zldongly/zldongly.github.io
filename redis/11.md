# 第十一章

**AOF持久化**

除了RDB外redis还有AOF（Append Only File）持久化功能，
AOF与RDB不同的是他记录的是redis所执行的命令，append也就是追加的意思，
每执行一个修改redis数据库的命令，AOF都会一追加的方式写到AOF文件中。  
```
struct redisServer {
    sds aof_buf
    ...
}
```  
aof_buf是一个缓冲，命令会被加在aof_buf末尾

> 文件的写入和同步  
在现代操作系统中，写文件write函数并不会马上把数据写进文件中，
而是暂存在一个缓存中，等到缓存存满或一定时间后才会真正写入文件。  
这样虽然提高了效率，但降低了可靠性。

redis中有三种appendfsync文件同步策略：  
* always  
    每次缓冲直接写入并同步到AOF文件
* everysec  
    距离上次文件同步时间超过1秒则同步，也就是1秒同步一次
* no  
    不主动同步，交给操作系统来决定  

## AOF的数据还原

还原步骤：  
1. 创建一个伪客户端  
2. 从AOF文件读取一条命令
3. 伪客户端执行2中读取的命令 
4. 重复步骤2和3

## AOF重写

> 因为AOF是以追加的形式记录数据的，所以随着时间的推移AOF文件中记录的内容会不断增加。
伪了防止文件过大，redis也有一套重写AOF文件的方法，来去掉一些冗余的记录。  

重写AOF文件并不是去解析原来的AOF文件，这样做太复杂。
最直接的方法就是直接去读当前正在运行的redis中存在的数据。  
为了不阻塞服务器主进程，重写AOF在子进程中进行并且读的是当前数据的副本，
如果在重写期间执行了新的用户命令则暂时存在aof_buf和特定的AOF重写缓存中（存两份），
AOF重写结束后再把新的AOF重写缓存中的内容追加到新的AOF文件中，然后替换旧的AOF文件。

[目录](./0.md)
